<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8">
  
  <title>Picasso源码解析 | Liuyunyicai</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="一、Picasso使用：gradle:
1compile &amp;apos;com.squareup.picasso:picasso:2.5.2&amp;apos;
使用：
1Picasso.with(this).load(&amp;quot;http://...../photo3.jpg&amp;quot;).into(myImg);
自定义的使用方法：
12345678910111213Picasso picasso =">
<meta property="og:type" content="article">
<meta property="og:title" content="Picasso源码解析">
<meta property="og:url" content="http://liuyunyicai.github.io/2016/05/15/Picasso源码解析/index.html">
<meta property="og:site_name" content="Liuyunyicai">
<meta property="og:description" content="一、Picasso使用：gradle:
1compile &amp;apos;com.squareup.picasso:picasso:2.5.2&amp;apos;
使用：
1Picasso.with(this).load(&amp;quot;http://...../photo3.jpg&amp;quot;).into(myImg);
自定义的使用方法：
12345678910111213Picasso picasso =">
<meta property="og:image" content="http://chuantu.biz/t4/15/1463301611x3738746547.png">
<meta property="og:image" content="http://chuantu.biz/t4/15/1463301826x3738746571.png">
<meta property="og:image" content="http://chuantu.biz/t4/15/1463302281x3738746571.png">
<meta property="og:updated_time" content="2016-05-15T09:10:03.213Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Picasso源码解析">
<meta name="twitter:description" content="一、Picasso使用：gradle:
1compile &amp;apos;com.squareup.picasso:picasso:2.5.2&amp;apos;
使用：
1Picasso.with(this).load(&amp;quot;http://...../photo3.jpg&amp;quot;).into(myImg);
自定义的使用方法：
12345678910111213Picasso picasso =">
<meta name="twitter:image" content="http://chuantu.biz/t4/15/1463301611x3738746547.png">
  
    <link rel="alternative" href="/atom.xml" title="Liuyunyicai" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
      <link href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css" rel="stylesheet">
  
  
  
      <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
      <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">
  
  <link rel="stylesheet" href="/css/style.css">
  
  <link href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  
  
      <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">
  
  <script src="//cdn.bootcss.com/jquery/1.9.1/jquery.min.js"></script>
  <script src="//cdn.bootcss.com/clipboard.js/1.5.9/clipboard.min.js"></script>
  <script>
      var yiliaConfig = {
          fancybox: true,
          animate: true,
          isHome: false,
          isPost: true,
          isArchive: false,
          isTag: false,
          isCategory: false,
          open_in_new: false,
          fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
          scrollreveal: "//cdn.bootcss.com/scrollReveal.js/3.0.9/scrollreveal.min.js"
      }
  </script>

  
      <script>
          yiliaConfig.rootUrl = "/";
      </script>
  

  
  
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/img/liuyunyicai.png" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">流云易采</a></h1>
        </hgroup>

        
                


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">文章列表</a></li>
                        
                            <li><a href="/tags/">标签云</a></li>
                        
                            <li><a href="/about/">关于我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="/979724798@qq.com" title="Email"></a>
                            
                                <a class="fa GitHub" target="_blank" href="#" title="GitHub"></a>
                            
                                <a class="fa RSS" target="_blank" href="/atom.xml" title="RSS"></a>
                            
                                <a class="fa CSDN" target="_blank" href="http://blog.csdn.net/woliuyunyicai" title="CSDN"></a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="https://hexo.io">Hexo</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="https://pages.github.com/">GitHub</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">Android,Java</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">流云易采</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/img/liuyunyicai.png" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">流云易采</a></h1>
            </hgroup>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">文章列表</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                    <li><a href="/about/">关于我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="/979724798@qq.com" title="Email"></a>
                            
                                <a class="fa GitHub" target="_blank" href="#" title="GitHub"></a>
                            
                                <a class="fa RSS" target="_blank" href="/atom.xml" title="RSS"></a>
                            
                                <a class="fa CSDN" target="_blank" href="http://blog.csdn.net/woliuyunyicai" title="CSDN"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="标签" friends="友情链接" about="关于我"/>
</nav>
      <div class="body-wrap"><article id="post-Picasso源码解析" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/05/15/Picasso源码解析/" class="article-date">
      <time datetime="2016-05-15T09:05:09.139Z" itemprop="datePublished">2016-05-15</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Picasso源码解析
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        

        
        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h2 id="一、Picasso使用："><a href="#一、Picasso使用：" class="headerlink" title="一、Picasso使用："></a>一、Picasso使用：</h2><p><strong>gradle:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compile &apos;com.squareup.picasso:picasso:2.5.2&apos;</span><br></pre></td></tr></table></figure>
<p><strong>使用：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Picasso.with(this).load(&quot;http://...../photo3.jpg&quot;).into(myImg);</span><br></pre></td></tr></table></figure>
<p><strong>自定义的使用方法：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Picasso picasso = <span class="keyword">new</span> Picasso.Builder(<span class="keyword">this</span>)</span><br><span class="line">        .memoryCache(<span class="keyword">new</span> LruCache())       <span class="comment">// 设置自定义的内存缓存</span></span><br><span class="line">        .addRequestHandler(requestHandler) <span class="comment">// 设置自定义的RequestHandler</span></span><br><span class="line">        .defaultBitmapConfig(bitmapConfig) <span class="comment">// 设置自定义的Bitmap Config</span></span><br><span class="line">        .downloader(okHttpDownloader)      <span class="comment">// 设置自定义的Downloader</span></span><br><span class="line">        .executor(executorService)         <span class="comment">// 设置自定义的线程池</span></span><br><span class="line">        .requestTransformer(transformer)   <span class="comment">// 设置自定义的Transformor</span></span><br><span class="line">        .listener(listener)                <span class="comment">// 添加Listener进行监听</span></span><br><span class="line">        .build();</span><br><span class="line">picasso.load(File/resId/Uri/String)</span><br><span class="line">        .resize(width, height)</span><br><span class="line">        .centerInside()</span><br><span class="line">        .into(imageView);</span><br></pre></td></tr></table></figure>
<h1 id="二、源码分析"><a href="#二、源码分析" class="headerlink" title="二、源码分析"></a>二、源码分析</h1><h2 id="（一）Picasso-with进行一系列初始化"><a href="#（一）Picasso-with进行一系列初始化" class="headerlink" title="（一）Picasso.with进行一系列初始化"></a>（一）Picasso.with进行一系列初始化</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Picasso <span class="title">with</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (singleton == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (Picasso.class) &#123;</span><br><span class="line">            <span class="keyword">if</span> (singleton == <span class="keyword">null</span>) &#123;</span><br><span class="line">                singleton = <span class="keyword">new</span> Builder(context).build();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> singleton;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>简单的多线程单例模式；同时使用Buidler模式来创建Picasso实例。</p>
<h3 id="1、Picasso-Builder-build"><a href="#1、Picasso-Builder-build" class="headerlink" title="1、Picasso.Builder#build:"></a>1、Picasso.Builder#build:</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Start building a new &#123;<span class="doctag">@link</span> Picasso&#125; instance. */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Builder</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (context == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Context must not be null."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.context = context.getApplicationContext();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Downloader downloader;</span><br><span class="line"><span class="keyword">private</span> ExecutorService service;</span><br><span class="line"><span class="keyword">private</span> Cache cache;</span><br><span class="line"><span class="keyword">private</span> Listener listener;</span><br><span class="line"><span class="keyword">private</span> RequestTransformer transformer;</span><br><span class="line"><span class="keyword">private</span> List&lt;RequestHandler&gt; requestHandlers;</span><br><span class="line"><span class="keyword">private</span> Bitmap.Config defaultBitmapConfig;</span><br><span class="line"><span class="comment">/** Create the &#123;<span class="doctag">@link</span> Picasso&#125; instance. */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Picasso <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Context context = <span class="keyword">this</span>.context;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 为这一系列变量进行默认初始化</span></span><br><span class="line">    <span class="comment">// Downloader执行实际的下载业务，返回Response</span></span><br><span class="line">    <span class="keyword">if</span> (downloader == <span class="keyword">null</span>) &#123;</span><br><span class="line">        downloader = Utils.createDefaultDownloader(context);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 内存缓存，可以看到默认的是LruCache</span></span><br><span class="line">    <span class="keyword">if</span> (cache == <span class="keyword">null</span>) &#123;</span><br><span class="line">        cache = <span class="keyword">new</span> LruCache(context);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 线程池，执行网络请求的地方</span></span><br><span class="line">    <span class="keyword">if</span> (service == <span class="keyword">null</span>) &#123;</span><br><span class="line">        service = <span class="keyword">new</span> PicassoExecutorService();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// request发送前进行处理</span></span><br><span class="line">    <span class="keyword">if</span> (transformer == <span class="keyword">null</span>) &#123;</span><br><span class="line">        transformer = RequestTransformer.IDENTITY;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 用以统计</span></span><br><span class="line">    Stats stats = <span class="keyword">new</span> Stats(cache);</span><br><span class="line">    <span class="comment">// 进行Request以及Response的转发</span></span><br><span class="line">    Dispatcher dispatcher = <span class="keyword">new</span> Dispatcher(context, service, HANDLER, downloader, cache, stats);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建一个Picasso</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Picasso(context, dispatcher, cache, listener, transformer, requestHandlers, stats,</span><br><span class="line">            defaultBitmapConfig, indicatorsEnabled, loggingEnabled);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到这里为许多重要类进行了默认初始化，后面获取图片使用到的都是这些默认的变量，当然这些变量也都可以进行自定义；<br><strong>Downloader：</strong>默认实现是OkHttpDownloader，Picasso是对OkHttp的封装，它的网络请求以及对本地Cache的请求都是直接通过OkHttp来实现的；Downloader是实现本地磁盘查询，以及发起网络请求的类；<br><strong>Cache：</strong>内存缓存；这里采用的LruCache，也可以自行定义。缓存的是进行网络请求后，大小等裁剪之后的图片资源。<br><strong>PicassoExecutorService：</strong>Picasso之中的线程池，默认核心线程为3个，没有非核心线程；但也会根据手机当前的网络状态进行适时改变，比如WIFI状态的核心线程就为4个，而4G，3G，2G状态下的线程数分别为3,2,1个；<br><strong>Stats：</strong>进行一些数据统计，比如图片下载命中率等。<br><strong>RequestTransformer:</strong>用来预处理Request，必须修改域名等<br><strong>Dispatcher：</strong>用以分发任务，它通过启动了一个DispatcherThread线程，然后创建一个用来处理消息的DispatcherHandler，该Handler的数据处理是在DispatcherThread中进行的。<br>RequestHandler： </p>
<p>根据后面具体使用情况再做分析：</p>
<h3 id="2、Picasso-load"><a href="#2、Picasso-load" class="headerlink" title="2、Picasso#load:"></a>2、Picasso#load:</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> RequestCreator <span class="title">load</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (path == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RequestCreator(<span class="keyword">this</span>, <span class="keyword">null</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (path.trim().length() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Path must not be empty."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> load(Uri.parse(path));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> RequestCreator <span class="title">load</span><span class="params">(Uri uri)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RequestCreator(<span class="keyword">this</span>, uri, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里创建一个<strong>RequestCreator</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Picasso picasso;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Request.Builder data;</span><br><span class="line"></span><br><span class="line">RequestCreator(Picasso picasso, Uri uri, <span class="keyword">int</span> resourceId) &#123;</span><br><span class="line">    <span class="keyword">if</span> (picasso.shutdown) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">                <span class="string">"Picasso instance already shut down. Cannot submit new requests."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.picasso = picasso;</span><br><span class="line">    <span class="keyword">this</span>.data = <span class="keyword">new</span> Request.Builder(uri, resourceId, picasso.defaultBitmapConfig);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>data对应创建一个Request的Builder，这个Request中封装了了相应的请求信息，传入了请求加载图片的URI，已经resourceId，以及默认显示图片的配置信息。<br>进而一般调用into将图片加载到相应的控件中。</p>
<h3 id="3、RequestCreator-into："><a href="#3、RequestCreator-into：" class="headerlink" title="3、RequestCreator#into："></a>3、RequestCreator#into：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RequestCreator.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">into</span><span class="params">(ImageView target)</span> </span>&#123;</span><br><span class="line">    into(target, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">into</span><span class="params">(ImageView target, Callback callback)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> started = System.nanoTime();</span><br><span class="line">    <span class="comment">// 盘算是否是在主线程，如果不是则会抛出异常</span></span><br><span class="line">    checkMain();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (target == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Target must not be null."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断reqeust是否合法，即存在URI或者对应的resId，否则会取消该请求</span></span><br><span class="line">    <span class="keyword">if</span> (!data.hasImage()) &#123;</span><br><span class="line">        picasso.cancelRequest(target);</span><br><span class="line">        <span class="keyword">if</span> (setPlaceholder) &#123;</span><br><span class="line">            setPlaceholder(target, getPlaceholderDrawable());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断是否需要延期执行</span></span><br><span class="line">    <span class="keyword">if</span> (deferred) &#123;</span><br><span class="line">        <span class="comment">// 判断是否已经设置了宽高大小</span></span><br><span class="line">        <span class="keyword">if</span> (data.hasSize()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Fit cannot be used with resize."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取目标控件的宽高参数</span></span><br><span class="line">        <span class="keyword">int</span> width = target.getWidth();</span><br><span class="line">        <span class="keyword">int</span> height = target.getHeight();</span><br><span class="line">        <span class="comment">// 表示当前控件并未加载到界面上（宽或高为0）</span></span><br><span class="line">        <span class="keyword">if</span> (width == <span class="number">0</span> || height == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (setPlaceholder) &#123;</span><br><span class="line">                setPlaceholder(target, getPlaceholderDrawable());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 生成DeferredRequestCreator，加入相应队列进行处理</span></span><br><span class="line">            picasso.defer(target, <span class="keyword">new</span> DeferredRequestCreator(<span class="keyword">this</span>, target, callback));</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 设置Request.Builder中的宽高参数大小</span></span><br><span class="line">        data.resize(width, height);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建Request</span></span><br><span class="line">    Request request = createRequest(started);</span><br><span class="line">    <span class="comment">// 获取request对应的key</span></span><br><span class="line">    String requestKey = createKey(request);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据策略判断是够需要跳过读取MemoryCache</span></span><br><span class="line">    <span class="keyword">if</span> (shouldReadFromMemoryCache(memoryPolicy)) &#123; <span class="comment">// 尝试从MemoryCache中获取Bitmap</span></span><br><span class="line">        <span class="comment">// 根据Requeskey来获取相应的Bitmap</span></span><br><span class="line">        Bitmap bitmap = picasso.quickMemoryCacheCheck(requestKey);</span><br><span class="line">        <span class="keyword">if</span> (bitmap != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 如果从MemoryCache中获取到相应的bitmap，则取消request</span></span><br><span class="line">            picasso.cancelRequest(target);</span><br><span class="line">            <span class="comment">// 设置图片</span></span><br><span class="line">            setBitmap(target, picasso.context, bitmap, MEMORY, noFade, picasso.indicatorsEnabled);</span><br><span class="line">            <span class="keyword">if</span> (picasso.loggingEnabled) &#123;</span><br><span class="line">                log(OWNER_MAIN, VERB_COMPLETED, request.plainId(), <span class="string">"from "</span> + MEMORY);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 调用回调callback的onSuccess函数</span></span><br><span class="line">            <span class="keyword">if</span> (callback != <span class="keyword">null</span>) &#123;</span><br><span class="line">                callback.onSuccess();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果从MemoryCache获取图片失败，或者根据缓存策略直接跳过读取MemoryCache，则设置默认图片</span></span><br><span class="line">    <span class="keyword">if</span> (setPlaceholder) &#123;</span><br><span class="line">        setPlaceholder(target, getPlaceholderDrawable());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建ImageViewAction，Action里面包含了一次请求所需要的所有信息</span></span><br><span class="line">    Action action =</span><br><span class="line">            <span class="keyword">new</span> ImageViewAction(picasso, target, request, memoryPolicy, networkPolicy, errorResId,</span><br><span class="line">                    errorDrawable, requestKey, tag, callback, noFade);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将action入队列</span></span><br><span class="line">    picasso.enqueueAndSubmit(action);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>整个图片加载流程和一般的三级缓存加载流程相似，下图已经介绍地很清晰：<br><img src="http://chuantu.biz/t4/15/1463301611x3738746547.png" alt="enter image description here"><br>上面主要是尝试从MemoryCache中获取对应Bitmap，如果获取失败，再创建Action，通过将Action入队列，然后从本地Cache以及网络上去获取该图片。<br>接着上面enqueueAndSubmit继续分析</p>
<h3 id="4、Picasso-enqueueAndSubmit："><a href="#4、Picasso-enqueueAndSubmit：" class="headerlink" title="4、Picasso#enqueueAndSubmit："></a>4、Picasso#enqueueAndSubmit：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Picasso.java</span></span><br><span class="line"><span class="keyword">final</span> Map&lt;Object, Action&gt; targetToAction;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">enqueueAndSubmit</span><span class="params">(Action action)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 根据Action获取对应的Target</span></span><br><span class="line">    Object target = action.getTarget();</span><br><span class="line">    <span class="keyword">if</span> (target != <span class="keyword">null</span> &amp;&amp; targetToAction.get(target) != action) &#123;</span><br><span class="line">        <span class="comment">// This will also check we are on the main thread.</span></span><br><span class="line">        <span class="comment">// 取消该target对应的以前的请求</span></span><br><span class="line">        cancelExistingRequest(target);</span><br><span class="line">        <span class="comment">// 添加当前请求</span></span><br><span class="line">        targetToAction.put(target, action);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 提交action</span></span><br><span class="line">    submit(action);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>targetToAction是一个Map，它存储的是Target对应的Action，以Target为相应key值。<br>当新添加一个action时，首先尝试取消该Action对应的Target之前的Action请求，然后将新Action添加到Map中；<br>然后提交action请求；</p>
<p>先来看下取消一个Request的函数<strong>cancelExistingReqeust</strong>，常用的cancelReqeust也是直接调用该函数实现的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Picasso.java</span></span><br><span class="line"><span class="keyword">final</span> Map&lt;Object, Action&gt; targetToAction;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cancelExistingRequest</span><span class="params">(Object target)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 判断是否在主线程中进行</span></span><br><span class="line">    checkMain();</span><br><span class="line">    <span class="comment">// 从Map中移除该target对应action</span></span><br><span class="line">    Action action = targetToAction.remove(target);</span><br><span class="line">    <span class="comment">// 如果该Target之前存在对应的action</span></span><br><span class="line">    <span class="keyword">if</span> (action != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 则调用该action的cancel函数进行取消</span></span><br><span class="line">        action.cancel();</span><br><span class="line">        <span class="comment">// 并且调用Dispatcher进行分发cancel请求</span></span><br><span class="line">        dispatcher.dispatchCancel(action);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 对于ImageView类型的Target</span></span><br><span class="line">    <span class="keyword">if</span> (target <span class="keyword">instanceof</span> ImageView) &#123;</span><br><span class="line">        ImageView targetImageView = (ImageView) target;</span><br><span class="line">        <span class="comment">// 前面分析提到可能有需要延迟操作的请求，它是通过添加到DeferredRequestCreator来实现的，这里的需要将其cancel掉</span></span><br><span class="line">        DeferredRequestCreator deferredRequestCreator =</span><br><span class="line">                targetToDeferredRequestCreator.remove(targetImageView);</span><br><span class="line">        <span class="keyword">if</span> (deferredRequestCreator != <span class="keyword">null</span>) &#123;</span><br><span class="line">            deferredRequestCreator.cancel();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>简单的cancel逻辑：</strong><br>这里依然也需要先判断事件处理是否是在主线程中进行的；<br>然后尝试从targetToAction中删除该Target中对应的Action，如果该Action确实存在，则调用cancel函数取消该Action，并且调用Dispatcher来分发该cancel请求；<br>对应ImageView类型的target，前面分析中提到当需要defer即延迟的请求时，是通过创建DeferredReqeustCreator，并添加到一个Map中来实现的，这里同理应将其删除并cancel掉；<br>再来看看其cancel函数：</p>
<h4 id="1）Action-cancel"><a href="#1）Action-cancel" class="headerlink" title="1）Action#cancel:"></a>1）Action#cancel:</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ImageViewAction.java</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImageViewAction</span> <span class="keyword">extends</span> <span class="title">Action</span>&lt;<span class="title">ImageView</span>&gt; </span>&#123;</span><br><span class="line">    Callback callback;</span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">void</span> <span class="title">cancel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.cancel();</span><br><span class="line">        <span class="keyword">if</span> (callback != <span class="keyword">null</span>) &#123;</span><br><span class="line">            callback = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Action.java</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Action</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> cancelled;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">cancel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        cancelled = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>和Volley这些差不多，通过设置一个cancel标志来实现。</p>
<h4 id="2）-Dispatcher-dispatchCacnel"><a href="#2）-Dispatcher-dispatchCacnel" class="headerlink" title="2） Dispatcher#dispatchCacnel"></a>2） Dispatcher#dispatchCacnel</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Dispatcher.java</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dispatchCancel</span><span class="params">(Action action)</span> </span>&#123;</span><br><span class="line">    handler.sendMessage(handler.obtainMessage(REQUEST_CANCEL, action));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>分发逻辑较为简单，使用Handler来实现的；<br>这里来具体来看下Dispatcher的定义，来确定handler的定义；Dispathcer是在创建Picasso时默认创建了一个Dispathcer实例，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Picasso.java</span></span><br><span class="line">Dispatcher dispatcher = <span class="keyword">new</span> Dispatcher(context, service, HANDLER, downloader, cache, stats);</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> Handler HANDLER = <span class="keyword">new</span> Handler(Looper.getMainLooper()) &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而Dispatcher中的Handler并不是这个Handler，而是又做了一个封装：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.handler = <span class="keyword">new</span> DispatcherHandler(dispatcherThread.getLooper(), <span class="keyword">this</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Dispatcher.java</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DispatcherHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Dispatcher dispatcher;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DispatcherHandler</span><span class="params">(Looper looper, Dispatcher dispatcher)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(looper);</span><br><span class="line">        <span class="keyword">this</span>.dispatcher = dispatcher;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(<span class="keyword">final</span> Message msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">            <span class="keyword">case</span> REQUEST_SUBMIT: &#123;</span><br><span class="line">                Action action = (Action) msg.obj;</span><br><span class="line">                dispatcher.performSubmit(action);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> REQUEST_CANCEL: &#123;</span><br><span class="line">                Action action = (Action) msg.obj;</span><br><span class="line">                dispatcher.performCancel(action);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            .......</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                Picasso.HANDLER.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"Unknown handler message received: "</span> + msg.what);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Dispathcer的作用是通过handler将相应的操作逻辑转换到自己Looper对应线程中去实现，然后调用performCancel去具体处理该Action；<br>下面接着来看<strong>Dispatcher#performCancel：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Dispatcher.java</span></span><br><span class="line"><span class="keyword">final</span> Map&lt;String, BitmapHunter&gt; hunterMap;</span><br><span class="line"><span class="keyword">final</span> Set&lt;Object&gt; pausedTags;</span><br><span class="line"><span class="keyword">final</span> Map&lt;Object, Action&gt; pausedActions;</span><br><span class="line"><span class="keyword">final</span> Map&lt;Object, Action&gt; failedActions;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">performCancel</span><span class="params">(Action action)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获取Action对应的key</span></span><br><span class="line">    String key = action.getKey();</span><br><span class="line">    <span class="comment">// 根据key获取对应的BitmapHunter</span></span><br><span class="line">    BitmapHunter hunter = hunterMap.get(key);</span><br><span class="line">    <span class="comment">// 取消执行bitmapHunter</span></span><br><span class="line">    <span class="keyword">if</span> (hunter != <span class="keyword">null</span>) &#123;</span><br><span class="line">        hunter.detach(action);</span><br><span class="line">        <span class="keyword">if</span> (hunter.cancel()) &#123;</span><br><span class="line">            hunterMap.remove(key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从暂停map中删除对应action</span></span><br><span class="line">    <span class="keyword">if</span> (pausedTags.contains(action.getTag())) &#123;</span><br><span class="line">        pausedActions.remove(action.getTarget());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从失败map中删除对应Action</span></span><br><span class="line">    Action remove = failedActions.remove(action.getTarget());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 逻辑较为简单，主要从各个可能存储该Action的集合中将其删除，如果已经有Bitmap在执行，则调用去cancel去处理。里面引出一个重要的类BitmapHunter，下面将会进行介绍。</p>
<p>如果没有从MemoryCache中获取到Bitmap（分两种情况，一直是根据policy直接跳过从MemoryCache中获取；另一种是MemoryCache中并没有对应的Bitmap缓存），这是将会来到submit(Action);</p>
<h3 id="5、Picasso-submit"><a href="#5、Picasso-submit" class="headerlink" title="5、Picasso#submit:"></a>5、Picasso#submit:</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Picasso.java</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">submit</span><span class="params">(Action action)</span> </span>&#123;</span><br><span class="line">    dispatcher.dispatchSubmit(action);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>和前面类似。继续调用Dispatcher来分发submit事件，因此可以看出Dispatcher的主要作用是对Picasso（主线程）中发送的事件进行分发处理；<br>和dispatchCancel类似，接下来会来到performSubmit:</p>
<h3 id="6、Dispatcher-performSubmit"><a href="#6、Dispatcher-performSubmit" class="headerlink" title="6、Dispatcher#performSubmit:"></a>6、Dispatcher#performSubmit:</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Set&lt;Object&gt; pausedTags;</span><br><span class="line"><span class="keyword">final</span> Map&lt;Object, Action&gt; failedActions;</span><br><span class="line"><span class="keyword">final</span> Map&lt;Object, Action&gt; pausedActions;</span><br><span class="line"><span class="keyword">final</span> Map&lt;String, BitmapHunter&gt; hunterMap;</span><br><span class="line"><span class="keyword">final</span> ExecutorService service;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">performSubmit</span><span class="params">(Action action, <span class="keyword">boolean</span> dismissFailed)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 如果Action已经暂停</span></span><br><span class="line">    <span class="keyword">if</span> (pausedTags.contains(action.getTag())) &#123;</span><br><span class="line">        pausedActions.put(action.getTarget(), action);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取对应的BitmapHunter</span></span><br><span class="line">    BitmapHunter hunter = hunterMap.get(action.getKey());</span><br><span class="line">    <span class="keyword">if</span> (hunter != <span class="keyword">null</span>) &#123; <span class="comment">// 如果对应hunter不为null，表示前面有同样的请求在进行，因此这是可以合并请求</span></span><br><span class="line">        hunter.attach(action);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断是否已经关闭</span></span><br><span class="line">    <span class="keyword">if</span> (service.isShutdown()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建BitmapHunter</span></span><br><span class="line">    hunter = forRequest(action.getPicasso(), <span class="keyword">this</span>, cache, stats, action);</span><br><span class="line">    <span class="comment">// 将Bitmap提交到线程池</span></span><br><span class="line">    hunter.future = service.submit(hunter);</span><br><span class="line">    <span class="comment">// 保存Bitmap</span></span><br><span class="line">    hunterMap.put(action.getKey(), hunter);</span><br><span class="line">    <span class="keyword">if</span> (dismissFailed) &#123;</span><br><span class="line">        failedActions.remove(action.getTarget());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体的工作逻辑如下图：<br><img src="http://chuantu.biz/t4/15/1463301826x3738746571.png" alt="enter image description here"><br>当遇到相同的Action时，Picasso会通过BitmapHunter的Attach来合并相同的请求，避免同一个请求重复进行；简单看下attach：</p>
<h4 id="1）Bitmap-attach："><a href="#1）Bitmap-attach：" class="headerlink" title="1）Bitmap#attach："></a>1）Bitmap#attach：</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BitmapHunter.java</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">attach</span><span class="params">(Action action)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> loggingEnabled = picasso.loggingEnabled;</span><br><span class="line">    Request request = action.request;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果BitmapHunter对应的action仍未设置，则直接设置action返回</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.action == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.action = action;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建一个保存相同Action的ArrayList</span></span><br><span class="line">    <span class="keyword">if</span> (actions == <span class="keyword">null</span>) &#123;</span><br><span class="line">        actions = <span class="keyword">new</span> ArrayList&lt;Action&gt;(<span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    actions.add(action);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得Action的优先级</span></span><br><span class="line">    Picasso.Priority actionPriority = action.getPriority();</span><br><span class="line">    <span class="comment">// 如果新添加Action的Priority优先级高于原来的优先级，则更新该Bitmaphunter的优先级</span></span><br><span class="line">    <span class="keyword">if</span> (actionPriority.ordinal() &gt; priority.ordinal()) &#123;</span><br><span class="line">        priority = actionPriority;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到合并相同请求，则是在BitmapHunter中维护一个Action列表actions;<br>当新添加Action的Priority优先级高于原来的优先级，则更新该BitmapHunter的优先级大小；<br>这里在来关注下Picasso中的优先级问题：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * The priority of a request.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@see</span> RequestCreator#priority(Priority)</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> Priority &#123;</span><br><span class="line">  LOW,</span><br><span class="line">  NORMAL,</span><br><span class="line">  HIGH</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Picasso中Priority是个枚举类，总共分为LOW,NORMAL,HIGH三个等级；而相对应地，Volley中Request的Priority则多了一个IMMEDIATE等级；顺便提下Volley中Reqeust可以根据Priority进行执行的原因是因为其实现了Comparable接口：<br><strong>Volley#Reqeust:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Request</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Comparable</span>&lt;<span class="title">Request</span>&lt;<span class="title">T</span>&gt;&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> Priority &#123;</span><br><span class="line">        LOW,</span><br><span class="line">        NORMAL,</span><br><span class="line">        HIGH,</span><br><span class="line">        IMMEDIATE</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Request&lt;T&gt; other)</span> </span>&#123;</span><br><span class="line">        Priority left = <span class="keyword">this</span>.getPriority();</span><br><span class="line">        Priority right = other.getPriority();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// High-priority requests are "lesser" so they are sorted to the front.</span></span><br><span class="line">        <span class="comment">// Equal priorities are sorted by sequence number to provide FIFO ordering.</span></span><br><span class="line">        <span class="keyword">return</span> left == right ?</span><br><span class="line">                <span class="keyword">this</span>.mSequence - other.mSequence :</span><br><span class="line">                right.ordinal() - left.ordinal();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2）ExecutorService："><a href="#2）ExecutorService：" class="headerlink" title="2）ExecutorService："></a>2）ExecutorService：</h4><p>再来看下线程池ExecutorService，它是在Picasso创建之初Builder时就创建的，默认的实现为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Picasso.Builder</span></span><br><span class="line"><span class="keyword">private</span> ExecutorService service;</span><br><span class="line"><span class="keyword">if</span> (service == <span class="keyword">null</span>) &#123;</span><br><span class="line">    service = <span class="keyword">new</span> PicassoExecutorService();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="2-1）来看PicassoExecutorService："><a href="#2-1）来看PicassoExecutorService：" class="headerlink" title="2.1）来看PicassoExecutorService："></a>2.1）来看PicassoExecutorService：</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PicassoExecutorService</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PicassoExecutorService</span> <span class="keyword">extends</span> <span class="title">ThreadPoolExecutor</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 默认的线程池的线程数量</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_THREAD_COUNT = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    PicassoExecutorService() &#123;</span><br><span class="line">        <span class="keyword">super</span>(DEFAULT_THREAD_COUNT, DEFAULT_THREAD_COUNT, <span class="number">0</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">                <span class="keyword">new</span> PriorityBlockingQueue&lt;Runnable&gt;(), <span class="keyword">new</span> Utils.PicassoThreadFactory());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Picasso提供的是个默认核心线程数为3个，没有非核心线程（最大的线程数目也是为3），任务队列为PriorityBlockingQueue的线程池；<br>Picasso有个有趣的地方是，它可以根据当前应用的网络状态实时调整线程池中的线程数目：</p>
<h5 id="2-2）PicassoExecutorService-adjustThreadCount："><a href="#2-2）PicassoExecutorService-adjustThreadCount：" class="headerlink" title="2.2）PicassoExecutorService#adjustThreadCount："></a>2.2）PicassoExecutorService#adjustThreadCount：</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 根据网络状况调整线程池中线程的数量</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">adjustThreadCount</span><span class="params">(NetworkInfo info)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (info == <span class="keyword">null</span> || !info.isConnectedOrConnecting()) &#123;</span><br><span class="line">        setThreadCount(DEFAULT_THREAD_COUNT);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">switch</span> (info.getType()) &#123;</span><br><span class="line">        <span class="keyword">case</span> ConnectivityManager.TYPE_WIFI:</span><br><span class="line">        <span class="keyword">case</span> ConnectivityManager.TYPE_WIMAX:</span><br><span class="line">        <span class="keyword">case</span> ConnectivityManager.TYPE_ETHERNET:</span><br><span class="line">            setThreadCount(<span class="number">4</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ConnectivityManager.TYPE_MOBILE:</span><br><span class="line">            <span class="keyword">switch</span> (info.getSubtype()) &#123;</span><br><span class="line">                <span class="keyword">case</span> TelephonyManager.NETWORK_TYPE_LTE:  <span class="comment">// 4G</span></span><br><span class="line">                <span class="keyword">case</span> TelephonyManager.NETWORK_TYPE_HSPAP:</span><br><span class="line">                <span class="keyword">case</span> TelephonyManager.NETWORK_TYPE_EHRPD:</span><br><span class="line">                    setThreadCount(<span class="number">3</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> TelephonyManager.NETWORK_TYPE_UMTS: <span class="comment">// 3G</span></span><br><span class="line">                <span class="keyword">case</span> TelephonyManager.NETWORK_TYPE_CDMA:</span><br><span class="line">                <span class="keyword">case</span> TelephonyManager.NETWORK_TYPE_EVDO_0:</span><br><span class="line">                <span class="keyword">case</span> TelephonyManager.NETWORK_TYPE_EVDO_A:</span><br><span class="line">                <span class="keyword">case</span> TelephonyManager.NETWORK_TYPE_EVDO_B:</span><br><span class="line">                    setThreadCount(<span class="number">2</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> TelephonyManager.NETWORK_TYPE_GPRS: <span class="comment">// 2G</span></span><br><span class="line">                <span class="keyword">case</span> TelephonyManager.NETWORK_TYPE_EDGE:</span><br><span class="line">                    setThreadCount(<span class="number">1</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    setThreadCount(DEFAULT_THREAD_COUNT);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            setThreadCount(DEFAULT_THREAD_COUNT);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 线程线程数量</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setThreadCount</span><span class="params">(<span class="keyword">int</span> threadCount)</span> </span>&#123;</span><br><span class="line">    setCorePoolSize(threadCount);</span><br><span class="line">    setMaximumPoolSize(threadCount);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>即WIFI状态下线程数目为4，4G状态下为3,3G状态下为2,2G转态下线程池中只有一个线程；</p>
<p>再来看线程池中创建线程的Factory，看看Picasso的线程池中的线程有何特别之处：</p>
<h5 id="2-3）PicassoThreadFactory："><a href="#2-3）PicassoThreadFactory：" class="headerlink" title="2.3）PicassoThreadFactory："></a>2.3）PicassoThreadFactory：</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PicassoThreadFactory</span> <span class="keyword">implements</span> <span class="title">ThreadFactory</span> </span>&#123;</span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"NullableProblems"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Thread <span class="title">newThread</span><span class="params">(Runnable r)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PicassoThread(r);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PicassoThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PicassoThread</span><span class="params">(Runnable r)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(r);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Process.setThreadPriority(THREAD_PRIORITY_BACKGROUND);</span><br><span class="line">        <span class="keyword">super</span>.run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>PicassoThread简单的Thread，线程优先级为后台线程；<br>再看service提交submit一个BitmapHunter时的操作逻辑：</p>
<h5 id="2-4）PicassoExecutorService-submit"><a href="#2-4）PicassoExecutorService-submit" class="headerlink" title="2.4）PicassoExecutorService#submit:"></a>2.4）PicassoExecutorService#submit:</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PicassoExecutorService</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PicassoExecutorService</span> <span class="keyword">extends</span> <span class="title">ThreadPoolExecutor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 提交任务</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Future&lt;?&gt; submit(Runnable task) &#123;</span><br><span class="line">        PicassoFutureTask ftask = <span class="keyword">new</span> PicassoFutureTask((BitmapHunter) task);</span><br><span class="line">        execute(ftask);</span><br><span class="line">        <span class="keyword">return</span> ftask;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将BitmapHunter封装成PicassoFutureTask进行execute</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PicassoFutureTask</span> <span class="keyword">extends</span> <span class="title">FutureTask</span>&lt;<span class="title">BitmapHunter</span>&gt;</span><br><span class="line">            <span class="keyword">implements</span> <span class="title">Comparable</span>&lt;<span class="title">PicassoFutureTask</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> BitmapHunter hunter;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">PicassoFutureTask</span><span class="params">(BitmapHunter hunter)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(hunter, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">this</span>.hunter = hunter;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(PicassoFutureTask other)</span> </span>&#123;</span><br><span class="line">            Picasso.Priority p1 = hunter.getPriority();</span><br><span class="line">            Picasso.Priority p2 = other.hunter.getPriority();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// High-priority requests are "lesser" so they are sorted to the front.</span></span><br><span class="line">            <span class="comment">// Equal priorities are sorted by sequence number to provide FIFO ordering.</span></span><br><span class="line">            <span class="keyword">return</span> (p1 == p2 ? hunter.sequence - other.hunter.sequence : p2.ordinal() - p1.ordinal());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到在submit中将BitmapHunter封装成一个FutureTask进行execute;<br>PicassoFutureTask可以实现对当前Runnbale运行结果的查看及控制；同期它提供了和Volley一个样的Priority一样的优先级机制。</p>
<p>回到前面performSubmit的执行逻辑，接下来会创建以及执行BitmapHunter，下面重点介绍BitmapHunter，它是一个任务具体执行的整体：</p>
<h3 id="7、BitmapHunter"><a href="#7、BitmapHunter" class="headerlink" title="7、BitmapHunter:"></a>7、BitmapHunter:</h3><h4 id="1）Dispatcher-forReqeust："><a href="#1）Dispatcher-forReqeust：" class="headerlink" title="1）Dispatcher#forReqeust："></a>1）Dispatcher#forReqeust：</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BitmapHunter.java</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> BitmapHunter <span class="title">forRequest</span><span class="params">(Picasso picasso, Dispatcher dispatcher, Cache cache, Stats stats,</span><br><span class="line">                               Action action)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 根据Action获取对应Request</span></span><br><span class="line">    Request request = action.getRequest();</span><br><span class="line">    <span class="comment">// 获取requestHandlers</span></span><br><span class="line">    List&lt;RequestHandler&gt; requestHandlers = picasso.getRequestHandlers();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Index-based loop to avoid allocating an iterator.</span></span><br><span class="line">    <span class="comment">//noinspection ForLoopReplaceableByForEach</span></span><br><span class="line">    <span class="comment">// 查找使用能够处理该Request的requesthandler，如果有则传入BitmapHandler</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, count = requestHandlers.size(); i &lt; count; i++) &#123;</span><br><span class="line">        RequestHandler requestHandler = requestHandlers.get(i);</span><br><span class="line">        <span class="keyword">if</span> (requestHandler.canHandleRequest(request)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> BitmapHunter(picasso, dispatcher, cache, stats, action, requestHandler);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 使用默认的ERRORING_HANDLER来构造BitmapHunter</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> BitmapHunter(picasso, dispatcher, cache, stats, action, ERRORING_HANDLER);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先判断Picasso中是否已经设置了能够处理该Request的requestHandler，如果存在则传入BitmapHandler,如果不存在，则使用默认的ERRORING_HANDLER来构造BitmapHandler；<br>简单看下ERRORING_HANDLER:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BitmapHunter.java</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> RequestHandler ERRORING_HANDLER = <span class="keyword">new</span> RequestHandler() &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">canHandleRequest</span><span class="params">(Request data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Result <span class="title">load</span><span class="params">(Request request, <span class="keyword">int</span> networkPolicy)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unrecognized type of request: "</span> + request);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>事实上处理Request请求主要是通过reqeustHandler的load函数来进行处理的，然后将处理后的结果封装成Result，然后返回；Picasso在其构造函数中提供了一些列的RequestHandler：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">List&lt;RequestHandler&gt; allRequestHandlers =</span><br><span class="line">    <span class="keyword">new</span> ArrayList&lt;RequestHandler&gt;(builtInHandlers + extraCount);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ResourceRequestHandler needs to be the first in the list to avoid</span></span><br><span class="line"><span class="comment">// forcing other RequestHandlers to perform null checks on request.uri</span></span><br><span class="line"><span class="comment">// to cover the (request.resourceId != 0) case.</span></span><br><span class="line">allRequestHandlers.add(<span class="keyword">new</span> ResourceRequestHandler(context));</span><br><span class="line"><span class="keyword">if</span> (extraRequestHandlers != <span class="keyword">null</span>) &#123;</span><br><span class="line">  allRequestHandlers.addAll(extraRequestHandlers);</span><br><span class="line">&#125;</span><br><span class="line">allRequestHandlers.add(<span class="keyword">new</span> ContactsPhotoRequestHandler(context));</span><br><span class="line">allRequestHandlers.add(<span class="keyword">new</span> MediaStoreRequestHandler(context));</span><br><span class="line">allRequestHandlers.add(<span class="keyword">new</span> ContentStreamRequestHandler(context));</span><br><span class="line">allRequestHandlers.add(<span class="keyword">new</span> AssetRequestHandler(context));</span><br><span class="line">allRequestHandlers.add(<span class="keyword">new</span> FileRequestHandler(context));</span><br><span class="line">allRequestHandlers.add(<span class="keyword">new</span> NetworkRequestHandler(dispatcher.downloader, stats));</span><br><span class="line">requestHandlers = Collections.unmodifiableList(allRequestHandlers);</span><br></pre></td></tr></table></figure>
<p>可以看到，按照不同的Request，Picasso提供了不同的RequestHandler进行处理，比如从资源中进行加载的则使用ResourceRequestHandler，从文件中加载则调用FileRequestHandler,从网络中直接下载使用NetworkRequestHandler等等。<br>下面将会看到这些RequestHandler的具体处理作用；</p>
<h4 id="2）BitmapHunter"><a href="#2）BitmapHunter" class="headerlink" title="2）BitmapHunter:"></a>2）BitmapHunter:</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BitmapHunter.java</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BitmapHunter</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Global lock for bitmap decoding to ensure that we are only are decoding one at a time. Since</span><br><span class="line">     * this will only ever happen in background threads we help avoid excessive memory thrashing as</span><br><span class="line">     * well as potential OOMs. Shamelessly stolen from Volley.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object DECODE_LOCK = <span class="keyword">new</span> Object();</span><br><span class="line">    <span class="meta">@Override</span> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            updateThreadName(data);</span><br><span class="line">            <span class="comment">// 主要的执行逻辑在hunt方法中</span></span><br><span class="line">            result = hunt();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 通过Dispatcher来分发运行之后的结果</span></span><br><span class="line">            <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</span><br><span class="line">                dispatcher.dispatchFailed(<span class="keyword">this</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                dispatcher.dispatchComplete(<span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 下面是进行运行过程中的一邪猎以往情况的处理</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Downloader.ResponseException e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!e.localCacheOnly || e.responseCode != <span class="number">504</span>) &#123;</span><br><span class="line">                exception = e;</span><br><span class="line">            &#125;</span><br><span class="line">            dispatcher.dispatchFailed(<span class="keyword">this</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NetworkRequestHandler.ContentLengthException e) &#123;</span><br><span class="line">            exception = e;</span><br><span class="line">            dispatcher.dispatchRetry(<span class="keyword">this</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            exception = e;</span><br><span class="line">            dispatcher.dispatchRetry(<span class="keyword">this</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (OutOfMemoryError e) &#123;</span><br><span class="line">            StringWriter writer = <span class="keyword">new</span> StringWriter();</span><br><span class="line">            stats.createSnapshot().dump(<span class="keyword">new</span> PrintWriter(writer));</span><br><span class="line">            exception = <span class="keyword">new</span> RuntimeException(writer.toString(), e);</span><br><span class="line">            dispatcher.dispatchFailed(<span class="keyword">this</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            exception = e;</span><br><span class="line">            dispatcher.dispatchFailed(<span class="keyword">this</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Thread.currentThread().setName(Utils.THREAD_IDLE_NAME);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> BitmapHunter实际上是一个Runnable,重点看其run中的执行逻辑；看到执行较为简单，都是通过hunt这个函数来实现的，获取到结果后，根据结果的成功与否，通过Dispatcher进行转发结果；<br>BitmapHunter中有一个成员变量较为有趣，DECODE_LOCK，这个变量在Volley中出现过，而且代码作者也说这是它从Volley中学习过来来，从名称中就可以看出，它是用来在解码图片时使用的锁，用来保证系统在同一时刻只有一个线程在解码图片；</p>
<h5 id="2-1）Bitmap-hunt"><a href="#2-1）Bitmap-hunt" class="headerlink" title="2.1）Bitmap#hunt:"></a>2.1）Bitmap#hunt:</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BitmapHunter.java</span></span><br><span class="line"><span class="keyword">final</span> Request data;</span><br><span class="line"><span class="function">Bitmap <span class="title">hunt</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    Bitmap bitmap = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里还是先尝试从MemoryCache中去获取Bitmap</span></span><br><span class="line">    <span class="keyword">if</span> (shouldReadFromMemoryCache(memoryPolicy)) &#123;</span><br><span class="line">        bitmap = cache.get(key);</span><br><span class="line">        <span class="keyword">if</span> (bitmap != <span class="keyword">null</span>) &#123; <span class="comment">// 如果获取成功，直接返回</span></span><br><span class="line">            stats.dispatchCacheHit(); <span class="comment">// 统计命中信息</span></span><br><span class="line">            loadedFrom = MEMORY;      <span class="comment">// loadedFrom记录表示从Memory缓存中获取</span></span><br><span class="line">            <span class="keyword">return</span> bitmap;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    data.networkPolicy = retryCount == <span class="number">0</span> ? NetworkPolicy.OFFLINE.index : networkPolicy;</span><br><span class="line">    <span class="comment">// 通过RequestHandler.load来处理Request获取结果</span></span><br><span class="line">    RequestHandler.Result result = requestHandler.load(data, networkPolicy);</span><br><span class="line">    <span class="comment">// 如果处理结果成功</span></span><br><span class="line">    <span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span><br><span class="line">        loadedFrom = result.getLoadedFrom();</span><br><span class="line">        exifRotation = result.getExifOrientation();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 从结果中获取Bitmap</span></span><br><span class="line">        bitmap = result.getBitmap();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If there was no Bitmap then we need to decode it from the stream.</span></span><br><span class="line">        <span class="comment">// 如果Bitmap为null，则需要将Stream转化成Bitmap</span></span><br><span class="line">        <span class="keyword">if</span> (bitmap == <span class="keyword">null</span>) &#123;</span><br><span class="line">            InputStream is = result.getStream();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                bitmap = decodeStream(is, data); <span class="comment">// 将网络数据流decode成Bitmap</span></span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                Utils.closeQuietly(is);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (bitmap != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 更新统计信息   </span></span><br><span class="line">        stats.dispatchBitmapDecoded(bitmap);</span><br><span class="line">        <span class="comment">// 判断是否需要进行Transformation，即进行转换</span></span><br><span class="line">        <span class="keyword">if</span> (data.needsTransformation() || exifRotation != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 这里体现了前面提到的DECODE_LOCK的作用，它保证在同一时刻，只有一个线程在执行图形变换</span></span><br><span class="line">            <span class="keyword">synchronized</span> (DECODE_LOCK) &#123;</span><br><span class="line">                <span class="keyword">if</span> (data.needsMatrixTransform() || exifRotation != <span class="number">0</span>) &#123;</span><br><span class="line">                    bitmap = transformResult(data, bitmap, exifRotation);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (data.hasCustomTransformations()) &#123;</span><br><span class="line">                    bitmap = applyCustomTransformations(data.transformations, bitmap);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (bitmap != <span class="keyword">null</span>) &#123;</span><br><span class="line">                stats.dispatchBitmapTransformed(bitmap);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bitmap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>hunt获取Bitmap的流程也较为清晰，首先仍然进行一次尝试从MemoryCache中进行获取；<br>获取失败，通过requestHandler的load函数进行加载，加载返回的结果为Result；<br>然后判断获取到的结果是否已经是Bitmap，如果不是，则需要将其从Stream转化成Bitmap；<br>然后判断是否需要Transformation；使用Transformation可以实现对获取到的图片的转化，一般的使用方式为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Picasso.with(<span class="keyword">this</span>).load(<span class="string">""</span>).transform(<span class="keyword">new</span> Transformation() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Bitmap <span class="title">transform</span><span class="params">(Bitmap source)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 进行图片转换</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">key</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;).into(mImageView);</span><br></pre></td></tr></table></figure>
<p>使用transform方法中添加Transformation进行图片处理，相应的图片处理开源库picasso-transformations源码地址已经集成了一些常用的Transformation可以直接进行使用；<br>transform的主要作用是将新创建Transformation对象添加到Request的transformations这个ArrayList中；<br>因而判断Request是否需要进行transform的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Request.java</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">needsTransformation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> needsMatrixTransform() || hasCustomTransformations();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断是否需要矩阵变换</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">needsMatrixTransform</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> hasSize() || rotationDegrees != <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 即将Bitmap转化成ImageView适合的尺寸</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> targetWidth != <span class="number">0</span> || targetHeight != <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断用户是否添加了相应的Transformation</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">hasCustomTransformations</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> transformations != <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后根据需要，对图片进行转换；<br>这里转换时使用到了前面所提到的<strong>DECODE_LOCK</strong>，它保证在同一时刻，只有一个线程在执行图形变换操作；<br>流程梳理清楚了，下面接着来看通过requestHandler接着获取Bitmap的过程，这里通过NetworkRequestHandler为例，即从网络中获取；</p>
<h5 id="2-2）NetworkRequestHandler-load"><a href="#2-2）NetworkRequestHandler-load" class="headerlink" title="2.2）NetworkRequestHandler#load:"></a>2.2）NetworkRequestHandler#load:</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NetWorkRequestHandler.java</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NetworkRequestHandler</span> <span class="keyword">extends</span> <span class="title">RequestHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Downloader downloader;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> RequestHandler.<span class="function">Result <span class="title">load</span><span class="params">(Request request, <span class="keyword">int</span> networkPolicy)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 可以看到真正处理网络请求的操作时通过downloader来实现的</span></span><br><span class="line">        Downloader.Response response = downloader.load(request.uri, request.networkPolicy);</span><br><span class="line">        <span class="comment">// 下面处理response结果</span></span><br><span class="line">        <span class="keyword">if</span> (response == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 判断数据是从磁盘还是网络总获取的</span></span><br><span class="line">        Picasso.LoadedFrom loadedFrom = response.cached ? DISK : NETWORK;</span><br><span class="line"></span><br><span class="line">        Bitmap bitmap = response.getBitmap();</span><br><span class="line">        <span class="keyword">if</span> (bitmap != <span class="keyword">null</span>) &#123; <span class="comment">// 如果可以直接获取到Bitmap，则将其封装成Result，返回</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> RequestHandler.Result(bitmap, loadedFrom);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 否则获取其输入流InputStream</span></span><br><span class="line">        InputStream is = response.getInputStream();</span><br><span class="line">        <span class="keyword">if</span> (is == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Sometimes response content length is zero when requests are being replayed. Haven't found</span></span><br><span class="line">        <span class="comment">// root cause to this but retrying the request seems safe to do so.</span></span><br><span class="line">        <span class="comment">// 处理无效的Content长度为0的情况</span></span><br><span class="line">        <span class="keyword">if</span> (loadedFrom == DISK &amp;&amp; response.getContentLength() == <span class="number">0</span>) &#123;</span><br><span class="line">            Utils.closeQuietly(is);</span><br><span class="line">            <span class="comment">// 抛出ContentLengthException，在Bitmap的run函数中会处理该异常，会调用retry进行重试</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ContentLengthException(<span class="string">"Received response with 0 content-length header."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (loadedFrom == NETWORK &amp;&amp; response.getContentLength() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            stats.dispatchDownloadFinished(response.getContentLength());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 封装成Result，返回</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RequestHandler.Result(is, loadedFrom);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里可以看到，真正处理请求的其实是Downloader这个实例，处理后返回的结果为Response;<br>Response中返回的结果可能有两种情况，一种是可能已经获取到了bitmap，一种可能是InputStream，这里需要分别进行处理，封装成Result，返回给BitmapHunter；<br>这里有个细节，当从磁盘中获取的结果Content的长度为0时，这里会抛出ContentLengthException异常，在BitmapHunter的run函数中会处理该异常，会调用retry进行重试;<br>downloader也是在Picasso初始化时就创建了的，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (downloader == <span class="keyword">null</span>) &#123;</span><br><span class="line">  downloader = Utils.createDefaultDownloader(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="2-3）Downloader"><a href="#2-3）Downloader" class="headerlink" title="2.3）Downloader:"></a>2.3）Downloader:</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Utils.java</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> Downloader <span class="title">createDefaultDownloader</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Class.forName(<span class="string">"com.squareup.okhttp.OkHttpClient"</span>);</span><br><span class="line">        <span class="keyword">return</span> OkHttpLoaderCreator.create(context);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException ignored) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> UrlConnectionDownloader(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到这里提供了两种实现，一种是如果系统中已经添加了OkhttpClient依赖，则使用Class.forName加载OkHttpClient类时，会加载成功，这时使用OkHttpLoaderCreator进行创建，也就是下面的网络请求通过okHttp来实现；否则是使用Android中默认提供的UrlConnection;这里一句OkHttp来进行分析；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Utils.java</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">OkHttpLoaderCreator</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> Downloader <span class="title">create</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> OkHttpDownloader(context);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>则Downloader的真是类型为OkHttpDownloader;<br>先来看下OkHttpDownloader的一些具体细节：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Utils.java</span></span><br><span class="line"><span class="comment">// 创建Cache的文件地址</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PICASSO_CACHE = <span class="string">"picasso-cache"</span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> File <span class="title">createDefaultCacheDir</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    File cache = <span class="keyword">new</span> File(context.getApplicationContext().getCacheDir(), PICASSO_CACHE);</span><br><span class="line">    <span class="keyword">if</span> (!cache.exists()) &#123;</span><br><span class="line">        <span class="comment">//noinspection ResultOfMethodCallIgnored</span></span><br><span class="line">        cache.mkdirs();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cache;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// OkHttpDownloader.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OkHttpDownloader</span> <span class="keyword">implements</span> <span class="title">Downloader</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> OkHttpClient <span class="title">defaultOkHttpClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">        <span class="comment">// 设置OkHttpClient中的一些参数</span></span><br><span class="line">        client.setConnectTimeout(Utils.DEFAULT_CONNECT_TIMEOUT_MILLIS, TimeUnit.MILLISECONDS);</span><br><span class="line">        client.setReadTimeout(Utils.DEFAULT_READ_TIMEOUT_MILLIS, TimeUnit.MILLISECONDS);</span><br><span class="line">        client.setWriteTimeout(Utils.DEFAULT_WRITE_TIMEOUT_MILLIS, TimeUnit.MILLISECONDS);</span><br><span class="line">        <span class="keyword">return</span> client;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> OkHttpClient client;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Create new downloader that uses OkHttp. This will install an image cache into your application</span><br><span class="line">     * cache directory.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="comment">// 一系列构造函数</span></span><br><span class="line">    <span class="comment">// 构造函数的主要作用其实只是为了创建OkHttpClient</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OkHttpDownloader</span><span class="params">(<span class="keyword">final</span> Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(Utils.createDefaultCacheDir(context));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OkHttpDownloader</span><span class="params">(<span class="keyword">final</span> File cacheDir)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(cacheDir, Utils.calculateDiskCacheSize(cacheDir));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OkHttpDownloader</span><span class="params">(<span class="keyword">final</span> File cacheDir, <span class="keyword">final</span> <span class="keyword">long</span> maxSize)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(defaultOkHttpClient());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 设置Cache地址，使用的是OkHttp中的Cache</span></span><br><span class="line">            client.setCache(<span class="keyword">new</span> com.squareup.okhttp.Cache(cacheDir, maxSize));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ignored) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OkHttpDownloader</span><span class="params">(OkHttpClient client)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.client = client;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里提供了一系列OkHttpDownloader的构造函数及创建细节，其实最主要的工作只是为了创建OkHttpClient；<br>具体来看其load执行网络请求的细节：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// OkHttpDownloader.java</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Downloader.<span class="function">Response <span class="title">load</span><span class="params">(Uri uri, <span class="keyword">int</span> networkPolicy)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    CacheControl cacheControl = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// 构建Cache的相关执行策略</span></span><br><span class="line">    <span class="keyword">if</span> (networkPolicy != <span class="number">0</span>) &#123; </span><br><span class="line">        <span class="keyword">if</span> (NetworkPolicy.isOfflineOnly(networkPolicy)) &#123; <span class="comment">// 如果要求强制从网络中获取</span></span><br><span class="line">            cacheControl = CacheControl.FORCE_CACHE;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            CacheControl.Builder builder = <span class="keyword">new</span> CacheControl.Builder();</span><br><span class="line">            <span class="keyword">if</span> (!NetworkPolicy.shouldReadFromDiskCache(networkPolicy)) &#123; <span class="comment">// 判断是否允许读取Disk缓存</span></span><br><span class="line">                builder.noCache(); <span class="comment">// DiskCache不允许读</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!NetworkPolicy.shouldWriteToDiskCache(networkPolicy)) &#123; <span class="comment">// 判断是否允许写入Disk缓存</span></span><br><span class="line">                builder.noStore(); <span class="comment">// DiskCache不允许写</span></span><br><span class="line">            &#125;</span><br><span class="line">            cacheControl = builder.build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据URI创建OkHttp中的Request</span></span><br><span class="line">    com.squareup.okhttp.Request.Builder builder = <span class="keyword">new</span> com.squareup.okhttp.Request.Builder().url(uri.toString());</span><br><span class="line">    <span class="keyword">if</span> (cacheControl != <span class="keyword">null</span>) &#123;</span><br><span class="line">        builder.cacheControl(cacheControl);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 典型的okHttp的同步执行方式来获取网络请求</span></span><br><span class="line">    com.squareup.okhttp.Response response = client.newCall(builder.build()).execute();</span><br><span class="line">    <span class="keyword">int</span> responseCode = response.code();</span><br><span class="line">    <span class="comment">// 处理失败的请求</span></span><br><span class="line">    <span class="keyword">if</span> (responseCode &gt;= <span class="number">300</span>) &#123;</span><br><span class="line">        response.body().close();</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Downloader.ResponseException(responseCode + <span class="string">" "</span> + response.message(), networkPolicy,</span><br><span class="line">                responseCode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> fromCache = response.cacheResponse() != <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    ResponseBody responseBody = response.body();</span><br><span class="line">    <span class="comment">// 将获取到的结果封装成Response返回给RequestHandler</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Downloader.Response(responseBody.byteStream(), fromCache, responseBody.contentLength());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>请求过程完全交由OkHttp来实现的，过程较为简单，不再赘述；这里有个细节问题，这里使用的OkHttp中的同步执行方式，因为这里执行load的线程就已经是非主线程了，故选择同步执行方式即可；具体的从DISK以及Network中来获取Response的工作完全交给OkHttp进行执行即可；<br>至此获取Bitmap的工作已经完成，主要的所有逻辑可以总结为<br>1）首先创建一个Request，Request中包含了一个请求中的相关信息，这是尝试从MemoryCache中获取，如果获取成功则直接返回，否则将Request封装成Action，然后enqueueAndSubmit；<br>2）在submit中，如果有相同的Action请求，则合并后来的Action请求，同一个actions集合，只需要执行一个Action就可以获取到结果；<br>如果之前并没有相同的Action请求，则使用Action创建一个Runnable即重要的BitmapHunter，通过线程池ExecutorService来submit执行；<br>3）BitmapHunter的主要执行逻辑在run函数中；而获取Bitmap的操作主要通过hunt函数来获取；hunt接着调用Request相对应的适合处理该request的RequestHandler的load函数进行处理，比如处理网络请求则需要使用NetworkRequestHandler;<br>4）RequestHandler的load函数其实也只是一层封装，真正执行网络请求的是Downloader这个类，对应于实际情况就是OkHttpDownloader;它的所有网络请求也都是直接交由OkHttp来完成的，因此Picasso和Retrofit一样都可以看做是对OkHttp的进一步封装；</p>
<p>获取Bitmap成功后，回来BitmapHunter的run方法继续来看对于结果是怎么处理的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过Dispatcher来分发运行之后的结果</span></span><br><span class="line"><span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</span><br><span class="line">    dispatcher.dispatchFailed(<span class="keyword">this</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    dispatcher.dispatchComplete(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="2-4）Dispatcher："><a href="#2-4）Dispatcher：" class="headerlink" title="2.4）Dispatcher："></a>2.4）Dispatcher：</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Dispatcher</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dispatchComplete</span><span class="params">(BitmapHunter hunter)</span> </span>&#123;</span><br><span class="line">    handler.sendMessage(handler.obtainMessage(HUNTER_COMPLETE, hunter));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DispatcherHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(<span class="keyword">final</span> Message msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">            <span class="keyword">case</span> HUNTER_COMPLETE: &#123;</span><br><span class="line">                BitmapHunter hunter = (BitmapHunter) msg.obj;</span><br><span class="line">                dispatcher.performComplete(hunter);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">performComplete</span><span class="params">(BitmapHunter hunter)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 判断是否允许写入到MemoryCache中</span></span><br><span class="line">    <span class="keyword">if</span> (shouldWriteToMemoryCache(hunter.getMemoryPolicy())) &#123;</span><br><span class="line">        cache.set(hunter.getKey(), hunter.getResult());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 从hunterMap中移除该BitmapHunter</span></span><br><span class="line">    hunterMap.remove(hunter.getKey());</span><br><span class="line">    batch(hunter);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> List&lt;BitmapHunter&gt; batch;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BATCH_DELAY = <span class="number">200</span>; <span class="comment">// ms</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">batch</span><span class="params">(BitmapHunter hunter)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 如果hunter取消了，则直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (hunter.isCancelled()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 进行打包发送</span></span><br><span class="line">    batch.add(hunter);</span><br><span class="line">    <span class="keyword">if</span> (!handler.hasMessages(HUNTER_DELAY_NEXT_BATCH)) &#123;</span><br><span class="line">        handler.sendEmptyMessageDelayed(HUNTER_DELAY_NEXT_BATCH, BATCH_DELAY);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Dispatcher即进行一些结果上的转发以及线程间的转换，都是同handler来实现的；前面提到这里handler对应的是DispatcherHandler，对应的Dispatcher所在的线程，然后使用该handler分发结果；<br>首先判断系统是否允许将获取到的结果写入到memoryCache中；然后执行完成过一个BitmapHunter之后，注意将其从hunterMap中移除；Picasso中分发结果是采用batch打包分发的，它每<strong>200ms</strong>分发一次，通过的就是batch函数中实现的；<br>handler发送一个延迟时间为200ms的类型为 HUNTER_DELAY_NEXT_BATCH的Message，在这200ms之内，下面将要转发的hunter事件，因为handler.hasMessages(HUNTER_DELAY_NEXT_BATCH)为true，故而会添加到一个ArrayList batch中，等到延迟时间到了，这200ms内所到达的所有hunter都会存储到batch中一并进行发送；来看具体的发送函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Dispatcher</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DispatcherHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(<span class="keyword">final</span> Message msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">            <span class="keyword">case</span> HUNTER_DELAY_NEXT_BATCH: &#123;</span><br><span class="line">                dispatcher.performBatchComplete();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">performBatchComplete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;BitmapHunter&gt; copy = <span class="keyword">new</span> ArrayList&lt;BitmapHunter&gt;(batch);</span><br><span class="line">    batch.clear();</span><br><span class="line">    mainThreadHandler.sendMessage(mainThreadHandler.obtainMessage(HUNTER_BATCH_COMPLETE, copy));</span><br><span class="line">    logBatch(copy);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>即通过主线程的Handler将结果发送到主线程；<br>mainThreadHandler对应的是Picasso中的静态内部类，来看其处理逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Picasso.java</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> Handler HANDLER = <span class="keyword">new</span> Handler(Looper.getMainLooper()) &#123;</span><br><span class="line">    <span class="meta">@Override</span> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">            <span class="keyword">case</span> HUNTER_BATCH_COMPLETE: &#123;</span><br><span class="line">                <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>) </span><br><span class="line">                List&lt;BitmapHunter&gt; batch = (List&lt;BitmapHunter&gt;) msg.obj;</span><br><span class="line">                <span class="comment">//noinspection ForLoopReplaceableByForEach</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, n = batch.size(); i &lt; n; i++) &#123;</span><br><span class="line">                    BitmapHunter hunter = batch.get(i);</span><br><span class="line">                    hunter.picasso.complete(hunter);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续来看<strong>complete：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Picasso.java</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">complete</span><span class="params">(BitmapHunter hunter)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获取Action</span></span><br><span class="line">    Action single = hunter.getAction();</span><br><span class="line">    List&lt;Action&gt; joined = hunter.getActions();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> hasMultiple = joined != <span class="keyword">null</span> &amp;&amp; !joined.isEmpty();</span><br><span class="line">    <span class="keyword">boolean</span> shouldDeliver = single != <span class="keyword">null</span> || hasMultiple;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!shouldDeliver) &#123; </span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Uri uri = hunter.getData().uri;</span><br><span class="line">    Exception exception = hunter.getException();</span><br><span class="line">    Bitmap result = hunter.getResult();</span><br><span class="line">    LoadedFrom from = hunter.getLoadedFrom();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (single != <span class="keyword">null</span>) &#123;</span><br><span class="line">        deliverAction(result, from, single);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hasMultiple) &#123;</span><br><span class="line">        <span class="comment">//noinspection ForLoopReplaceableByForEach</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, n = joined.size(); i &lt; n; i++) &#123;</span><br><span class="line">            Action join = joined.get(i);</span><br><span class="line">            deliverAction(result, from, join);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置Listener情况</span></span><br><span class="line">    <span class="keyword">if</span> (listener != <span class="keyword">null</span> &amp;&amp; exception != <span class="keyword">null</span>) &#123;</span><br><span class="line">        listener.onImageLoadFailed(<span class="keyword">this</span>, uri, exception);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>处理最终的结果，对于有合并相同Action的请求，则需要对应地分别进行处理；处理的函数均为deliverAction：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Picasso.java</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">deliverAction</span><span class="params">(Bitmap result, LoadedFrom from, Action action)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (action.isCancelled()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!action.willReplay()) &#123;</span><br><span class="line">        targetToAction.remove(action.getTarget());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (from == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"LoadedFrom cannot be null."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        action.complete(result, from);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        action.error();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>盗用一张图来解释所有的处理逻辑：<br><img src="http://chuantu.biz/t4/15/1463302281x3738746571.png" alt="enter image description here"></p>

      
    </div>
    
  </div>
  
    


    <nav id="article-nav">
        
            <div id="article-nav-newer" class="article-nav-title">
                <a href="/2016/05/16/Volley源码解析/">
                    Volley源码解析
                </a>
            </div>
        
        
            <div id="article-nav-older" class="article-nav-title">
                <a href="/2016/05/12/设计模式汇总--结构型模型/">
                    设计模式汇总--结构型模式
                </a>
            </div>
        
    </nav>

  
</article>

    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、Picasso使用："><span class="toc-number">1.</span> <span class="toc-text">一、Picasso使用：</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#二、源码分析"><span class="toc-number"></span> <span class="toc-text">二、源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#（一）Picasso-with进行一系列初始化"><span class="toc-number">1.</span> <span class="toc-text">（一）Picasso.with进行一系列初始化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、Picasso-Builder-build"><span class="toc-number">1.1.</span> <span class="toc-text">1、Picasso.Builder#build:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2、Picasso-load"><span class="toc-number">1.2.</span> <span class="toc-text">2、Picasso#load:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3、RequestCreator-into："><span class="toc-number">1.3.</span> <span class="toc-text">3、RequestCreator#into：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4、Picasso-enqueueAndSubmit："><span class="toc-number">1.4.</span> <span class="toc-text">4、Picasso#enqueueAndSubmit：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1）Action-cancel"><span class="toc-number">1.4.1.</span> <span class="toc-text">1）Action#cancel:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2）-Dispatcher-dispatchCacnel"><span class="toc-number">1.4.2.</span> <span class="toc-text">2） Dispatcher#dispatchCacnel</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5、Picasso-submit"><span class="toc-number">1.5.</span> <span class="toc-text">5、Picasso#submit:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6、Dispatcher-performSubmit"><span class="toc-number">1.6.</span> <span class="toc-text">6、Dispatcher#performSubmit:</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1）Bitmap-attach："><span class="toc-number">1.6.1.</span> <span class="toc-text">1）Bitmap#attach：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2）ExecutorService："><span class="toc-number">1.6.2.</span> <span class="toc-text">2）ExecutorService：</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1）来看PicassoExecutorService："><span class="toc-number">1.6.2.1.</span> <span class="toc-text">2.1）来看PicassoExecutorService：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2）PicassoExecutorService-adjustThreadCount："><span class="toc-number">1.6.2.2.</span> <span class="toc-text">2.2）PicassoExecutorService#adjustThreadCount：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3）PicassoThreadFactory："><span class="toc-number">1.6.2.3.</span> <span class="toc-text">2.3）PicassoThreadFactory：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4）PicassoExecutorService-submit"><span class="toc-number">1.6.2.4.</span> <span class="toc-text">2.4）PicassoExecutorService#submit:</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7、BitmapHunter"><span class="toc-number">1.7.</span> <span class="toc-text">7、BitmapHunter:</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1）Dispatcher-forReqeust："><span class="toc-number">1.7.1.</span> <span class="toc-text">1）Dispatcher#forReqeust：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2）BitmapHunter"><span class="toc-number">1.7.2.</span> <span class="toc-text">2）BitmapHunter:</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1）Bitmap-hunt"><span class="toc-number">1.7.2.1.</span> <span class="toc-text">2.1）Bitmap#hunt:</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2）NetworkRequestHandler-load"><span class="toc-number">1.7.2.2.</span> <span class="toc-text">2.2）NetworkRequestHandler#load:</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3）Downloader"><span class="toc-number">1.7.2.3.</span> <span class="toc-text">2.3）Downloader:</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4）Dispatcher："><span class="toc-number">1.7.2.4.</span> <span class="toc-text">2.4）Dispatcher：</span></a></li></ol></li></ol></li></ol></li></ol>
</div>
<style>
    .left-col .switch-btn {
        display: none;
    }
    .left-col .switch-area {
        display: none;
    }
</style>

<input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">
<script>
    var valueHide = "隐藏目录";
    var valueShow = "显示目录";

    if ($(".left-col").is(":hidden")) {
        $("#tocButton").attr("value", valueShow);
    }

    $("#tocButton").click(function() {
        if ($("#toc").is(":hidden")) {
            $("#tocButton").attr("value", valueHide);
            $("#toc").slideDown(320);
            $(".switch-btn, .switch-area").fadeOut(300);
        }
        else {
            $("#tocButton").attr("value", valueShow);
            $("#toc").slideUp(350);
            $(".switch-btn, .switch-area").fadeIn(500);
        }
    })

    if ($(".toc").length < 1) {
        $("#toc, #tocButton").hide();
        $(".switch-btn, .switch-area").show();
    }
</script>





    
<div class="share">
    
        <div class="bdsharebuttonbox">
            <a href="#" class="fa fa-twitter bds_twi" data-cmd="twi" title="分享到推特"></a>
            <a href="#" class="fa fa-weibo bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
            <a href="#" class="fa fa-qq bds_sqq" data-cmd="sqq" title="分享给 QQ 好友"></a>
            <a href="#" class="fa fa-files-o bds_copy" data-cmd="copy" title="复制网址"></a>
            <a href="#" class="fa fa fa-envelope-o bds_mail" data-cmd="mail" title="通过邮件分享"></a>
            <a href="#" class="fa fa-weixin bds_weixin" data-cmd="weixin" title="生成文章二维码"></a>
            <a href="#" class="fa fa-share-alt bds_more" data-cmd="more"></i></a>
        </div>
        <script>
            window._bd_share_config={
                "common":{"bdSnsKey":{},"bdText":"Picasso源码解析　| Liuyunyicai　","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
        </script>
    

    
</div>







    




    <div class="scroll" id="post-nav-button">
        
            <a href="/2016/05/16/Volley源码解析/" title="上一篇: Volley源码解析">
                <i class="fa fa-angle-left"></i>
            </a>
        

        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>

        
            <a href="/2016/05/12/设计模式汇总--结构型模型/" title="下一篇: 设计模式汇总--结构型模式">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>

    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/05/16/Fragment源码解析/">Fragment源码解析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/16/Volley源码解析/">Volley源码解析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/15/Picasso源码解析/">Picasso源码解析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/12/设计模式汇总--结构型模型/">设计模式汇总--结构型模式</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/10/View机制深入学习（五） 事件处理机制一/">View机制深入学习（五） 事件处理机制一</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/06/Retrofit源码解析/">Retrofit源码解析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/06/ArrayMapy、SparseArray源码学习/">ArrayMapy、SparseArray源码学习</a></li></ul>




    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2016 流云易采
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减 Hexo 双栏博客主题">Yelee</a> by MOxFIVE <i class="fa fa-heart animated infinite pulse"></i>
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" >本站到访数: 
                            <span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>, </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit">本页阅读量: 
                            <span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>
    </div>
    
<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.1.22/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 5;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>




<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>